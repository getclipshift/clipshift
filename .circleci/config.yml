# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  linux-win:
    docker:
      - image: cimg/go:1.19.5
    steps:
      - checkout
      - run:
          name: Dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y libx11-dev libgtk-3-dev libayatana-appindicator3-dev
            mkdir -p dist/linux/amd64
            mkdir -p dist/windows/amd64
            mkdir -p dist/windows/arm64
      - run:
          name: Linux
          command: CGO_ENABLED=1 go build -o dist/linux/amd64/clipshift main.go
      - run:
          name: Linux Tray
          command: CGO_ENABLED=1 go build -tags tray -o dist/linux/amd64/clipshift-tray main.go
      - run:
          name: Windows AMD64
          command: CGO_ENABLED=1 GOOS=windows GOARCH=amd64 go build -o dist/windows/amd64/clipshift main.go
      - run:
          name: Windows AMD64 Tray
          command: CGO_ENABLED=1 GOOS=windows GOARCH=amd64 go build -tags tray -ldflags -H=windowsgui -o dist/windows/amd64/clipshift-tray main.go
      - run:
          name: Windows ARM64
          command: CGO_ENABLED=1 GOOS=windows GOARCH=arm64 go build -o dist/windows/arm64/clipshift main.go
      - run:
          name: Windows ARM64 Tray
          command: CGO_ENABLED=1 GOOS=windows GOARCH=arm64 go build -tags tray -ldflags -H=windowsgui -o dist/windows/arm64/clipshift-tray main.go
      - persist_to_workspace:
          root: dist
          paths:
            - linux/amd64/clipshift
            - linux/amd64/clipshift-tray
            - windows/amd64/clipshift
            - windows/amd64/clipshift-tray
            - windows/arm64/clipshift
            - windows/arm64/clipshift-tray
  linux-arm:
    machine:
      image: ubuntu-2204:2022.10.2
    resource_class: arm.medium
    steps:
      - checkout
      - run:
          name: Dependencies
          command: |
            sudo apt-get update
            sudo NEEDRESTART_MODE=a apt-get install -y libx11-dev libgtk-3-dev libayatana-appindicator3-dev
            mkdir -p dist/linux/arm64
      - run:
          name: Linux ARM64
          command: CGO_ENABLED=1 go build -o dist/linux/arm64/clipshift main.go
      - run:
          name: Linux ARM64 Tray
          command: CGO_ENABLED=1 go build -tags tray -o dist/linux/arm64/clipshift-tray main.go
      - persist_to_workspace:
          root: dist
          paths:
            - linux/arm64/clipshift
            - linux/arm64/clipshift-tray
  mac-intel:
    macos:
      xcode: 12.5.1
    steps:
      - checkout
      - run:
          name: Dependencies
          command: |
            curl -Lo go.tar.gz https://go.dev/dl/go1.19.5.darwin-amd64.tar.gz
            sudo tar -C /usr/local -xzf go.tar.gz
            export PATH=$PATH:/usr/local/go/bin
            mkdir -p dist/darwin/amd64
      - run:
          name: Mac AMD64
          command: CGO_ENABLED=1 /usr/local/go/bin/go build -o dist/darwin/amd64/clipshift main.go
      - run:
          name: Mac AMD64 Tray
          command: CGO_ENABLED=1 /usr/local/go/bin/go build -tags tray -o dist/darwin/amd64/clipshift-tray main.go
      - persist_to_workspace:
          root: dist
          paths:
            - darwin/amd64/clipshift
            - darwin/amd64/clipshift-tray
  package:
    machine:
      image: ubuntu-2204:2022.10.2
    resource_class: medium
    steps:
      - checkout
      - attach_workspace:
          at: dist
      - run:
          name: Package Release
          command: |
            sudo apt-get install -y zip
            mkdir -p dist/release

            tar -czf dist/release/clipshift_linux_amd64.tar.gz dist/linux/amd64/clipshift
            tar -czf dist/release/clipshift-tray_linux_amd64.tar.gz dist/linux/amd64/clipshift-tray
            tar -czf dist/release/clipshift_linux_arm64.tar.gz dist/linux/arm64/clipshift
            tar -czf dist/release/clipshift-tray_linux_arm64.tar.gz dist/linux/arm64/clipshift-tray
            tar -czf dist/release/clipshift_darwin_amd64.tar.gz dist/darwin/amd64/clipshift
            tar -czf dist/release/clipshift-tray_darwin_amd64.tar.gz dist/darwin/amd64/clipshift-tray
            zip dist/release/clipshift_windows_amd64.zip dist/windows/amd64/clipshift
            zip dist/release/clipshift-tray_windows_amd64.zip dist/windows/amd64/clipshift-tray
            zip dist/release/clipshift_windows_arm64.zip dist/windows/arm64/clipshift
            zip dist/release/clipshift-tray_windows_arm64.zip dist/windows/arm64/clipshift-tray

            cd dist/release
            sha256sums clipshift_linux_amd64.tar.gz >> checksums.txt
            sha256sums clipshift-tray_linux_amd64.tar.gz >> checksums.txt
            sha256sums clipshift_linux_arm64.tar.gz >> checksums.txt
            sha256sums clipshift-tray_linux_arm64.tar.gz >> checksums.txt
            sha256sums clipshift_darwin_amd64.tar.gz >> checksums.txt
            sha256sums clipshift-tray_darwin_amd64.tar.gz >> checksums.txt
            sha256sums clipshift_windows_amd64.zip >> checksums.txt
            sha256sums clipshift-tray_windows_amd64.zip >> checksums.txt
            sha256sums clipshift_windows_arm64.zip >> checksums.txt
            sha256sums clipshift-tray_windows_arm64.zip >> checksums.txt
      - store_artifacts:
          path: dist/release

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build-and-test:
    jobs:
      - linux-win
      - linux-arm:
          requires:
            - linux-win
      - mac-intel:
          requires:
            - linux-win
      - package:
          requires:
            - linux-win
            - linux-arm
            - mac-intel
